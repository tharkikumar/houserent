<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mullick Villa Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .navbar-brand { font-weight: bold; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; display: none; }
        
        /* Print Styles for Invoice */
        @media print {
            body * { visibility: hidden; } 
            #invoice-area, #invoice-area * { visibility: visible; } 
            #invoice-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="#">Mullick Villa</a>
        <span class="navbar-text text-light d-none d-md-block" style="font-size: 0.8rem;">
            House No-460, Block E, Shri Ram Colony, Khajoori Khas, Delhi 110090
        </span>
        <button class="btn btn-outline-light btn-sm ms-auto" onclick="logout()">Logout</button>
    </div>
</nav>

<div class="container mt-4">

    <div id="login-section">
        <div class="row justify-content-center">
            <div class="col-md-5">
                <div class="card p-4">
                    <h4 class="text-center mb-4">Portal Login</h4>
                    
                    <ul class="nav nav-tabs mb-3" id="loginTabs">
                        <li class="nav-item"><a class="nav-link active" onclick="switchLogin('tenant')" href="#">Tenant</a></li>
                        <li class="nav-item"><a class="nav-link" onclick="switchLogin('admin')" href="#">Landlord</a></li>
                    </ul>

                    <div id="tenant-login-form">
                        <div class="mb-3">
                            <label>Unit No</label>
                            <select id="login-unit" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label>PIN (Your Unit No)</label>
                            <input type="password" id="login-pin" class="form-control" placeholder="Enter Unit No again">
                        </div>
                        <button class="btn btn-primary w-100" onclick="tenantLogin()">Login</button>
                    </div>

                    <div id="admin-login-form" class="hidden">
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="admin-pass" class="form-control">
                        </div>
                        <button class="btn btn-danger w-100" onclick="adminLogin()">Admin Access</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-dashboard" class="hidden">
        <h3 class="mb-3">Landlord Dashboard <small class="text-muted fs-6">Mamta Mullick</small></h3>
        
        <ul class="nav nav-pills mb-3" style="font-size: 0.9rem;">
            <li class="nav-item"><button class="nav-link active" onclick="showTab('tab-bill')">Billing</button></li>
            <li class="nav-item"><button class="nav-link" onclick="showTab('tab-cash')">Cash Receiver</button></li>
            <li class="nav-item"><button class="nav-link" onclick="showTab('tab-reg')">Register</button></li>
            <li class="nav-item"><button class="nav-link" onclick="showTab('tab-manage')">Manage Tenants</button></li> 
            <li class="nav-item"><button class="nav-link" onclick="showTab('tab-rep')">Reports</button></li>
            <li class="nav-item"><button class="nav-link" onclick="showTab('tab-set')">Settings</button></li>
        </ul>

        <div id="tab-bill" class="dashboard-tab">
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Generate Bill</h5>
                        <select id="bill-unit" class="form-select mb-2"></select>
                        
                        <div class="row g-1 mb-2">
                            <div class="col-6">
                                <label class="form-label mb-0" style="font-size: 0.75rem;">From Date</label>
                                <input type="date" id="bill-start" class="form-control form-control-sm">
                            </div>
                            <div class="col-6">
                                <label class="form-label mb-0" style="font-size: 0.75rem;">To Date</label>
                                <input type="date" id="bill-end" class="form-control form-control-sm">
                            </div>
                        </div>

                        <input type="number" id="bill-new-meter" class="form-control mb-2" placeholder="New Meter Reading">
                        <button class="btn btn-success w-100" onclick="generateBill()">Calculate & Save</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Print Invoice</h5>
                        <select id="print-unit" class="form-select mb-2"></select>
                        <button class="btn btn-dark w-100" onclick="previewInvoice()">Preview & Print</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3">
                        <h5>Vacate Unit</h5>
                        <select id="vacate-unit" class="form-select mb-2"></select>
                        <button class="btn btn-danger w-100" onclick="vacateUnit()">Mark Empty</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cash" class="dashboard-tab hidden">
            <div class="card p-4 col-md-6">
                <h5>Receive Cash Payment</h5>
                <select id="cash-unit" class="form-select mb-2"></select>
                <input type="number" id="cash-amount" class="form-control mb-2" placeholder="Amount Received">
                <button class="btn btn-success" onclick="payCash()">Record Payment</button>
            </div>
        </div>

        <div id="tab-reg" class="dashboard-tab hidden">
            <div class="card p-4 col-md-8">
                <h5>New Tenant Registration</h5>
                <div class="row">
                    <div class="col-6 mb-2"><input type="text" id="reg-name" class="form-control" placeholder="Name"></div>
                    <div class="col-6 mb-2"><input type="text" id="reg-phone" class="form-control" placeholder="Phone"></div>
                    
                    <div class="col-6 mb-2">
                        <label class="form-label mb-0" style="font-size: 0.8rem;">Entry Date</label>
                        <input type="date" id="reg-date" class="form-control">
                    </div>

                    <div class="col-6 mb-2">
                        <label class="form-label mb-0" style="font-size: 0.8rem;">Select Unit</label>
                        <select id="reg-unit" class="form-select"></select>
                    </div>
                    <div class="col-6 mb-2"><input type="number" id="reg-rent" class="form-control" placeholder="Base Rent"></div>
                    <div class="col-6 mb-2">
                        <select id="reg-type" class="form-select">
                            <option value="Advance">Advance Rent</option>
                            <option value="Postpaid">Postpaid</option>
                        </select>
                    </div>
                    <div class="col-6 mb-2"><input type="number" id="reg-sec" class="form-control" placeholder="Security Deposit"></div>
                    <div class="col-6 mb-2"><input type="number" id="reg-meter" class="form-control" placeholder="Start Meter Reading"></div>
                </div>
                <button class="btn btn-primary mt-2" onclick="registerTenant()">Register Tenant</button>
            </div>
        </div>

        <div id="tab-manage" class="dashboard-tab hidden">
            <div class="card p-4 col-md-8">
                <h5>Edit Existing Tenant</h5>
                <div class="d-flex gap-2 mb-4">
                    <select id="edit-unit" class="form-select"></select>
                    <button class="btn btn-info" onclick="loadTenantData()">Load Details</button>
                </div>

                <div id="edit-form" class="hidden">
                    <hr>
                    <div class="row">
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Name</label>
                            <input type="text" id="edit-name" class="form-control">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Phone</label>
                            <input type="text" id="edit-phone" class="form-control">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Entry Date</label>
                            <input type="date" id="edit-date" class="form-control">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Base Rent</label>
                            <input type="number" id="edit-rent" class="form-control">
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Rent Type</label>
                            <select id="edit-type" class="form-select">
                                <option value="Advance">Advance Rent</option>
                                <option value="Postpaid">Postpaid</option>
                            </select>
                        </div>
                        <div class="col-6 mb-2">
                            <label class="form-label mb-0" style="font-size: 0.8rem;">Security Deposit</label>
                            <input type="number" id="edit-sec" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-warning mt-3 w-100" onclick="saveTenantData()">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="tab-rep" class="dashboard-tab hidden">
            <div class="card p-3">
                <div class="d-flex gap-2">
                    <input type="date" id="rep-start" class="form-control">
                    <input type="date" id="rep-end" class="form-control">
                    <button class="btn btn-info" onclick="getReport()">Get Report</button>
                </div>
                <div class="mt-3 table-responsive">
                    <table class="table table-bordered" id="rep-table">
                        <thead><tr><th>Date</th><th>Type</th><th>Unit</th><th>Tenant</th><th>Amount</th><th>Notes</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-set" class="dashboard-tab hidden">
            <div class="row">
                <div class="col-md-6">
                    <div class="card p-4">
                        <h5>Global Settings</h5>
                        <label>Electricity Rate (per unit)</label>
                        <input type="number" id="set-rate" class="form-control mb-2">
                        <label>Landlord UPI ID</label>
                        <input type="text" id="set-upi" class="form-control mb-2">
                        <button class="btn btn-warning" onclick="updateSettings()">Update Settings</button>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card p-4 border-danger">
                        <h5 class="text-danger">Danger Zone</h5>
                        <p class="text-muted small">This will delete all Tenants and Transactions, and reset all Units to Vacant with 0 meters. Use this to clear test data or start a new financial year.</p>
                        <button class="btn btn-danger" onclick="resetDatabase()">RESET DATABASE</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tenant-dashboard" class="hidden">
        <h2 id="t-welcome">Welcome</h2>
        <p class="text-muted mb-0"><strong>Move-in Date:</strong> <span id="t-entry-date">N/A</span></p>
        
        <div class="card p-4 mt-3 border-primary" style="border-width: 2px;">
            <h4 class="text-primary">Current Bill Status</h4>
            <hr>
            <div class="row text-center">
                <div class="col-3">
                    <small class="text-muted">Base Rent</small>
                    <h5 id="t-rent">0</h5>
                </div>
                <div class="col-3">
                    <small class="text-muted">Electricity</small>
                    <h5 id="t-elec">0</h5>
                </div>
                <div class="col-3">
                    <small class="text-muted">Arrears</small>
                    <h5 id="t-arr">0</h5>
                </div>
                <div class="col-3">
                    <small class="text-danger fw-bold">Total Due</small>
                    <h4 class="text-danger fw-bold" id="t-total">0</h4>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <a id="pay-link" href="#" class="btn btn-success btn-lg px-5 mb-3">PAY NOW via UPI App</a>
                <br>
                <button class="btn btn-outline-dark btn-sm" onclick="document.getElementById('qr-box').classList.remove('hidden')">Show QR Code</button>
                
                <div id="qr-box" class="hidden mt-3">
                    <p>Scan to Pay:</p>
                    <img id="qr-img" src="" alt="QR Code" style="width: 150px;">
                </div>
            </div>
        </div>
    </div>

</div>

<div id="invoice-area" class="bg-white p-5 hidden">
    <div class="text-center mb-4">
        <h1>MULLICK VILLA</h1>
        <p>House No-460, Block E, Shri Ram Colony, Khajoori Khas, Delhi 110090<br>
        Landlord: Mamta Mullick</p>
        <hr>
    </div>
    <div class="row">
        <div class="col-6">
            <h5>Bill To:</h5>
            <p>Name: <span id="inv-name"></span><br>Unit: <span id="inv-unit"></span></p>
            <p class="mb-0"><small>Move-in Date: <span id="inv-entry-date"></span></small></p>
        </div>
        <div class="col-6 text-end">
            <h5>Date of Issue: <span id="inv-date"></span></h5>
            <p class="mb-0"><strong>Billing Period:</strong> <span id="inv-period"></span></p>
        </div>
    </div>
    <table class="table table-bordered mt-3">
        <thead><tr><th>Description</th><th class="text-end">Amount (₹)</th></tr></thead>
        <tbody>
            <tr><td>Monthly Rent</td><td class="text-end" id="inv-rent"></td></tr>
            <tr><td>Electricity Charges</td><td class="text-end" id="inv-elec"></td></tr>
            <tr><td>Previous Arrears</td><td class="text-end" id="inv-arr"></td></tr>
            <tr class="table-dark"><td><strong>TOTAL DUE</strong></td><td class="text-end"><strong id="inv-total"></strong></td></tr>
        </tbody>
    </table>
    <div class="mt-4 row">
        <div class="col-8">
            <p><strong>Payment Instructions:</strong><br>Please pay via UPI or Cash immediately.<br>Keep this receipt for your records.</p>
        </div>
        <div class="col-4 text-center">
            <img id="inv-qr" src="" style="width: 100px;">
            <p><small>Scan to Pay</small></p>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbx0c_ZmX7ox_pkNkjHg7OhRS5X7WPzAgUFGiFJtw8wppJSk0LQw95sCzNcydadihwhI/exec"; // <--- PUT YOUR DEPLOYMENT URL HERE
    
    // --- GLOBAL STATE ---
    let metaData = {};

    // --- INITIALIZATION ---
    window.onload = async function() {
        document.getElementById('loader').style.display = 'flex';
        try {
            await fetchMeta();
            apiCall({ action: 'SETUP_SYSTEM' }); 
        } catch(e) { console.error("Connection Error", e); }
        document.getElementById('loader').style.display = 'none';
    };

    // --- API HELPER ---
    async function apiCall(data) {
        document.getElementById('loader').style.display = 'flex';
        const response = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(data)
        });
        const json = await response.json();
        document.getElementById('loader').style.display = 'none';
        if(json.status === 'error') { alert("Error: " + json.message); throw new Error(json.message); }
        return json.data;
    }

    async function fetchMeta() {
        const data = await apiCall({ action: 'GET_METADATA' });
        metaData = data;
        populateDropdowns();
    }

    function populateDropdowns() {
        const units = metaData.units;
        const statuses = metaData.unitStatuses;
        
        let opts = "<option value=''>Select Unit</option>";
        let vacants = "<option value=''>Select Unit</option>";
        let occupied = "<option value=''>Select Unit</option>";

        units.forEach(u => {
            const statusRow = statuses.find(s => s[0] == u);
            const isVacant = statusRow ? statusRow[1] === "Vacant" : true;
            
            opts += `<option value="${u}">${u}</option>`;
            if(isVacant) vacants += `<option value="${u}">${u}</option>`;
            if(!isVacant) occupied += `<option value="${u}">${u}</option>`;
        });

        document.getElementById('login-unit').innerHTML = occupied;
        document.getElementById('bill-unit').innerHTML = occupied;
        document.getElementById('print-unit').innerHTML = occupied;
        document.getElementById('cash-unit').innerHTML = occupied;
        document.getElementById('vacate-unit').innerHTML = occupied;
        document.getElementById('reg-unit').innerHTML = vacants;
        document.getElementById('edit-unit').innerHTML = occupied; 
        
        document.getElementById('set-rate').value = metaData.rate;
        document.getElementById('set-upi').value = metaData.upi;
    }

    // --- UI LOGIC ---
    function switchLogin(type) {
        document.getElementById('tenant-login-form').classList.toggle('hidden', type !== 'tenant');
        document.getElementById('admin-login-form').classList.toggle('hidden', type !== 'admin');
        document.querySelector('.nav-link.active').classList.remove('active');
        event.target.classList.add('active');
    }

    function logout() {
        location.reload();
    }

    function showTab(id) {
        document.querySelectorAll('.dashboard-tab').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('#admin-dashboard .nav-link').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- ACTIONS ---

    function adminLogin() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === "admin") {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
        } else {
            alert("Wrong Password");
        }
    }

    async function tenantLogin() {
        const unit = document.getElementById('login-unit').value;
        const pin = document.getElementById('login-pin').value;
        
        const data = await apiCall({ action: 'GET_TENANT', unit: unit, pin: pin });
        
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('tenant-dashboard').classList.remove('hidden');
        
        document.getElementById('t-welcome').innerText = `Welcome, ${data.name}`;
        const entryDateDisplay = data.entryDate ? new Date(data.entryDate).toLocaleDateString() : "N/A";
        document.getElementById('t-entry-date').innerText = entryDateDisplay; 

        document.getElementById('t-rent').innerText = "₹" + data.rent;
        document.getElementById('t-elec').innerText = "₹" + data.elec;
        document.getElementById('t-arr').innerText = "₹" + data.arrears;
        document.getElementById('t-total').innerText = "₹" + data.total;
        
        const upiLink = `upi://pay?pa=${data.upi}&pn=MamtaMullick&am=${data.total}&cu=INR`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
        
        document.getElementById('pay-link').href = upiLink;
        document.getElementById('qr-img').src = qrUrl;
    }

    async function registerTenant() {
        const entryDate = document.getElementById('reg-date').value;
        if (!entryDate) return alert("Please select an Entry Date.");

        const data = {
            action: 'REGISTER_TENANT',
            name: document.getElementById('reg-name').value,
            phone: document.getElementById('reg-phone').value,
            unit: document.getElementById('reg-unit').value,
            rent: document.getElementById('reg-rent').value,
            type: document.getElementById('reg-type').value,
            security: document.getElementById('reg-sec').value,
            startMeter: document.getElementById('reg-meter').value,
            entryDate: entryDate
        };
        const res = await apiCall(data);
        alert(`${res.msg}\nLogin PIN is now set to Unit No: ${data.unit}`);
        location.reload();
    }

    // --- EDIT TENANT FUNCTIONS ---
    async function loadTenantData() {
        const unit = document.getElementById('edit-unit').value;
        if (!unit) return alert("Select a Unit");

        const data = await apiCall({ action: 'GET_TENANT_ADMIN', unit: unit });
        
        document.getElementById('edit-name').value = data.name;
        document.getElementById('edit-phone').value = data.phone;
        document.getElementById('edit-date').value = data.entryDate;
        document.getElementById('edit-rent').value = data.rent;
        document.getElementById('edit-type').value = data.type;
        document.getElementById('edit-sec').value = data.security;

        document.getElementById('edit-form').classList.remove('hidden');
    }

    async function saveTenantData() {
        const data = {
            action: 'EDIT_TENANT',
            unit: document.getElementById('edit-unit').value,
            name: document.getElementById('edit-name').value,
            phone: document.getElementById('edit-phone').value,
            entryDate: document.getElementById('edit-date').value,
            rent: document.getElementById('edit-rent').value,
            type: document.getElementById('edit-type').value,
            security: document.getElementById('edit-sec').value
        };

        const res = await apiCall(data);
        alert(res);
        fetchMeta(); 
    }

    // --- RESET DATABASE FUNCTION ---
    async function resetDatabase() {
        const confirmText = prompt("WARNING: This will delete ALL tenants, ALL transactions, and reset all units to zero. \n\nType 'RESET' to confirm:");
        if (confirmText !== "RESET") {
            alert("Reset Cancelled.");
            return;
        }

        const res = await apiCall({ action: 'RESET_DATABASE' });
        alert(res);
        location.reload();
    }

    async function generateBill() {
        const unit = document.getElementById('bill-unit').value;
        const meter = document.getElementById('bill-new-meter').value;
        const start = document.getElementById('bill-start').value;
        const end = document.getElementById('bill-end').value;

        if(!unit || !meter || !start || !end) return alert("Please fill in the Meter Reading and the Billing Dates.");
        
        const res = await apiCall({ 
            action: 'GENERATE_BILL', 
            unit: unit, 
            newMeter: meter,
            startDate: start,
            endDate: end
        });
        alert(res);
        fetchMeta(); 
    }

    async function payCash() {
        const unit = document.getElementById('cash-unit').value;
        const amount = document.getElementById('cash-amount').value;
        if(!unit || !amount) return alert("Fill all fields");

        const res = await apiCall({ action: 'PAY_CASH', unit: unit, amount: amount });
        alert(res);
    }

    async function vacateUnit() {
        if(!confirm("Are you sure? This will remove the tenant.")) return;
        const unit = document.getElementById('vacate-unit').value;
        const res = await apiCall({ action: 'VACATE_UNIT', unit: unit });
        alert(res);
        location.reload();
    }

    async function updateSettings() {
        const res = await apiCall({
            action: 'UPDATE_SETTINGS',
            newRate: document.getElementById('set-rate').value,
            newUpi: document.getElementById('set-upi').value
        });
        alert(res);
    }

    async function getReport() {
        const start = document.getElementById('rep-start').value;
        const end = document.getElementById('rep-end').value;
        if(!start || !end) return alert("Select dates");
        
        const data = await apiCall({ action: 'GET_REPORT', start: start, end: end });
        const tbody = document.querySelector('#rep-table tbody');
        tbody.innerHTML = "";
        data.forEach(row => {
            const date = new Date(row[0]).toLocaleDateString();
            tbody.innerHTML += `<tr><td>${date}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td><td>${row[7]}</td></tr>`;
        });
    }

    async function previewInvoice() {
        const unit = document.getElementById('print-unit').value;
        if(!unit) return alert("Select Unit");
        
        const data = await apiCall({ action: 'GET_BILL_ADMIN', unit: unit });
        
        document.getElementById('inv-name').innerText = data.name;
        document.getElementById('inv-unit').innerText = unit;
        
        const entryDateDisplay = data.entryDate ? new Date(data.entryDate).toLocaleDateString() : "N/A";
        document.getElementById('inv-entry-date').innerText = entryDateDisplay;

        document.getElementById('inv-date').innerText = new Date().toLocaleDateString();
        
        const periodStr = data.lastStart && data.lastEnd 
            ? `${new Date(data.lastStart).toLocaleDateString()} to ${new Date(data.lastEnd).toLocaleDateString()}` 
            : 'N/A';
        document.getElementById('inv-period').innerText = periodStr;

        document.getElementById('inv-rent').innerText = data.rent;
        document.getElementById('inv-elec').innerText = data.elec;
        document.getElementById('inv-arr').innerText = data.arrears;
        document.getElementById('inv-total').innerText = "₹ " + data.total;
        
        const upiLink = `upi://pay?pa=${data.upi}&pn=MamtaMullick&am=${data.total}&cu=INR`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiLink)}`;
        document.getElementById('inv-qr').src = qrUrl;

        const invoiceArea = document.getElementById('invoice-area');
        invoiceArea.classList.remove('hidden');
        window.print();
        invoiceArea.classList.add('hidden');
    }
</script>
</body>
</html>
